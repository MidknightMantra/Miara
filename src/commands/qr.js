/**
 * ğŸŒŒ Miara Command: QR â€” Celestial Encoder (Baileys 7-Ready)
 * -----------------------------------------------------------
 * Transmutes any text or link into a glowing digital sigil (QR Code).
 * by MidKnightMantra ğŸŒ¸ â€” â€œEvery code carries a whisper of its creator.â€
 */

import QRCode from "qrcode";
import { config } from "../config.js";
import { safeQuoted, safeReact } from "../utils/helpers.js";

export default {
  name: "qr",
  aliases: ["qrcode", "sigil", "encode"],
  description: "Transform text or links into luminous QR sigils âœ¨",
  category: "tools",
  usage: ".qr <text_or_url>",

  async execute(conn, m, args) {
    try {
      const chat = m.key.remoteJid;
      const qrData = args.join(" ").trim();

      // ğŸ§© Validate input
      if (!qrData) {
        await conn.sendMessage(
          chat,
          {
            text:
              "ğŸŒ™ Please share text or a link to encode.\n\n" +
              "Example:\n.qr https://miara.ai\n.qr Miara awakens ğŸŒ¸"
          },
          safeQuoted(m)
        );
        return;
      }

      // ğŸŒ¸ Identify content
      const isUrl = /^https?:\/\//i.test(qrData);
      const typeEmoji = isUrl ? "ğŸŒ" : qrData.length > 30 ? "ğŸ“œ" : "ğŸ’ ";
      const title = isUrl ? "Celestial Link Portal" : "Encoded Sigil";

      await safeReact(conn, m, "âœ¨");
      console.log(`âœ¨ Generating QR code for: ${qrData}`);

      // ğŸ¨ Generate QR buffer
      const qrBuffer = await QRCode.toBuffer(qrData, {
        width: 400,
        margin: 2,
        color: {
          dark: "#4B0082", // Indigo glow
          light: "#FAF5FF" // Soft lavender background
        }
      });

      // ğŸŒ¸ Caption
      const caption = `
${typeEmoji} *${title}*
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“¦ *Content:* \`\`\`${qrData}\`\`\`
ğŸª· *Generated by:* ${config.BOT_NAME || "Miara ğŸŒ¸"}
ğŸŒ  *Timestamp:* ${new Date().toLocaleString()}
      `.trim();

      // âœ‰ï¸ Send QR image safely
      await conn.sendMessage(
        chat,
        {
          image: qrBuffer,
          caption
        },
        safeQuoted(m)
      );

      await safeReact(conn, m, "ğŸ’«");
      console.log(`âœ… QR code sent successfully to ${chat}`);
    } catch (err) {
      console.error("âŒ QR generation error:", err);
      const errorText = `
âš ï¸ *QR Transmutation Failed*
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸª Reason: ${err.message || "Unknown error"}
ğŸ’­ Hint: Try simpler text or shorter URLs.
      `.trim();

      const chat = m?.key?.remoteJid;
      if (chat) {
        await conn.sendMessage(chat, { text: errorText }, safeQuoted(m));
        await safeReact(conn, m, "ğŸ’”");
      }
    }
  }
};
