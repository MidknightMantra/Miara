/**
 * ğŸŒŒ Miara Command: QR â€” Celestial Encoder
 * -----------------------------------------
 * Transmutes any text or link into a glowing digital sigil (QR Code).
 * by MidKnightMantra ğŸŒ¸ â€” â€œEvery code carries a whisper of its creator.â€
 */

import QRCode from "qrcode";
import { config } from "../config.js";

export default {
  name: "qr",
  aliases: ["qrcode", "sigil", "encode"],
  description: "Transform text or links into luminous QR sigils âœ¨",
  category: "tools",
  usage: ".qr <text_or_url>",

  async execute(conn, m, args) {
    const { from } = m;
    const qrData = args.join(" ").trim();

    // ğŸ§© Input validation
    if (!qrData) {
      await conn.sendMessage(from, {
        text: "ğŸŒ™ Please share text or a link to encode.\nExample:\n.qr https://miara.ai\n.qr Miara awakens ğŸŒ¸",
      });
      return;
    }

    // ğŸ’« Determine the kind of content
    const isUrl = /^https?:\/\//i.test(qrData);
    const typeEmoji = isUrl ? "ğŸŒ" : qrData.length > 30 ? "ğŸ“œ" : "ğŸ’ ";
    const title = isUrl ? "Celestial Link Portal" : "Encoded Sigil";

    try {
      console.log(`âœ¨ Generating QR code for: ${qrData}`);

      // ğŸ¨ Generate QR code (violet aesthetic)
      const qrBuffer = await QRCode.toBuffer(qrData, {
        width: 400,
        margin: 2,
        color: {
          dark: "#4B0082", // Indigo glow
          light: "#FAF5FF", // Soft lavender background
        },
      });

      // ğŸŒ¸ Caption design
      const caption = `
${typeEmoji} *${title}*
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“¦ *Content:* \`\`\`${qrData}\`\`\`
ğŸª· *Generated by:* ${config.BOT_NAME || "Miara ğŸŒ¸"}
ğŸŒ  *Timestamp:* ${new Date().toLocaleString()}
      `.trim();

      // âœ‰ï¸ Send the QR code image
      await conn.sendMessage(from, {
        image: qrBuffer,
        caption,
      });

      // React (if message key exists)
      if (m?.key) {
        await conn.sendMessage(from, { react: { text: "ğŸ’«", key: m.key } });
      }

      console.log(`âœ… QR code sent successfully to ${from}`);
    } catch (err) {
      console.error("âŒ QR generation error:", err);
      const errorText = `
âš ï¸ *QR Transmutation Failed*
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸª Reason: ${err.message || "Unknown error"}
ğŸ’­ Hint: Try simpler text or shorter URLs.
      `.trim();

      await conn.sendMessage(from, { text: errorText });

      if (m?.key) {
        await conn.sendMessage(from, { react: { text: "ğŸ’”", key: m.key } });
      }
    }
  },
};
